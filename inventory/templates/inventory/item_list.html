{% extends "global/base.html" %}
{% block page_title %}Itens{% endblock %}
{% block content %}

<style>
  [x-cloak]{display:none !important;}
</style>

<!-- CARDS DE M√âTRICAS -->
<div class="grid md:grid-cols-4 gap-4 mb-6">
  <div class="card bg-base-100 border"><div class="card-body">
    <span class="text-sm opacity-70">Total de estoque</span>
    <div class="text-3xl font-semibold">{{ stats.total_stock }}</div>
  </div></div>
  <div class="card bg-base-100 border"><div class="card-body">
    <span class="text-sm opacity-70">Itens ativos</span>
    <div class="text-3xl font-semibold">{{ stats.ativos }}</div>
  </div></div>
  <div class="card bg-base-100 border"><div class="card-body">
    <span class="text-sm opacity-70">Abaixo do m√≠nimo</span>
    <div class="text-3xl font-semibold">{{ stats.abaixo_min }}</div>
  </div></div>
  <div class="card bg-base-100 border"><div class="card-body">
    <span class="text-sm opacity-70">Total de itens</span>
    <div class="text-3xl font-semibold">{{ stats.itens }}</div>
  </div></div>
</div>

<!-- FILTRO / NOVO ITEM -->
<form method="get" class="flex gap-2 items-end mb-4">
  <label class="form-control w-full max-w-sm">
    <span class="label-text">Buscar</span>
    <input class="input input-bordered" type="text" name="q" value="{{ q }}" placeholder="SKU ou descri√ß√£o">
  </label>
  <a href="{% url 'inventory:item-create' %}" class="btn btn-primary ml-auto">+ Novo item</a>
</form>

<!-- TABELA + EXPAND -->
<div class="overflow-x-auto" x-data="{ openId: null }">
  <table class="table w-full">
    <thead class="bg-base-100 sticky top-0 z-10">
      <tr>
        <th class="w-12"></th>
        <th>SKU</th>
        <th>Descri√ß√£o</th>
        <th>Unidade</th>
        <th class="text-right">Estoque</th>
        <th class="text-right">Est. m√≠n.</th>
        <th>Status</th>
      </tr>
    </thead>

    {% for it in items %}
    <tbody :class="openId==={{ it.id }} ? 'bg-base-200/60' : ''" class="border-b">
      <!-- LINHA PRINCIPAL -->
      <tr class="hover">
        <td>
          <!-- seta cinza (heroicons solid) -->
          <button
            class="btn btn-primary btn-xs px-2 text-base-content/70 hover:text-base-content"
            @click="openId = (openId === {{ it.id }} ? null : {{ it.id }})"
            :aria-expanded="openId === {{ it.id }}">
            <svg class="w-4 h-4 transition-transform duration-200"
                 :class="openId === {{ it.id }} ? 'rotate-180' : ''"
                 viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd"
                    d="M5.23 7.21a.75.75 0 0 1 1.06.02L10 10.94l3.71-3.71a.75.75 0 1 1 1.06 1.06l-4.24 4.24a.75.75 0 0 1-1.06 0L5.25 8.29a.75.75 0 0 1-.02-1.08z"
                    clip-rule="evenodd"/>
            </svg>
          </button>
        </td>

        <td class="font-mono">{{ it.sku }}</td>

        <td class="font-medium">
          <a href="{% url 'inventory:item-detail' it.pk %}" class="link hover:link-primary">
            {{ it.descricao }}
          </a>
        </td>

        <!-- unidade como badge (kg, un, L, m, cx, pct...) -->
        <td>
          <span class="badge badge-outline">{{ it.unidade|default:"un" }}</span>
        </td>

        <td class="text-right">{{ it.stock }}</td>
        <td class="text-right">{{ it.estoque_minimo }}</td>

        <td>
          {% if it.is_active %}
            <span class="badge badge-success">Ativo</span>
          {% else %}
            <span class="badge badge-ghost">Inativo</span>
          {% endif %}
        </td>
      </tr>

      <!-- LINHA EXPANDIDA -->
      <tr x-show="openId === {{ it.id }}" x-cloak>
        <td></td>
        <!-- ‚Üì agora s√£o 6 colunas (sem A√ß√µes) -->
        <td colspan="6" class="p-0">
          <div class="p-4 md:p-6 bg-base-200 border-t" x-data="{ edit:false }">

            <!-- ‚ÄúGaleria‚Äù/Previews -->
            <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
              <div class="aspect-video rounded-xl bg-base-100 border grid place-items-center">üì¶</div>
              <div class="aspect-video rounded-xl bg-base-100 border grid place-items-center">üéõÔ∏è</div>
              <div class="aspect-video rounded-xl bg-base-100 border grid place-items-center">üß∞</div>
              <div class="aspect-video rounded-xl bg-base-100 border grid place-items-center">üñºÔ∏è</div>
            </div>

            <!-- VISUALIZA√á√ÉO -->
            <div x-show="!edit" x-cloak>
              <p class="mb-6 text-sm md:text-base leading-relaxed">
                <span class="font-semibold">{{ it.descricao }}</span> ‚Äî SKU <span class="font-mono">{{ it.sku }}</span>.
                Unidade: <span class="font-mono">{{ it.unidade|default:"un" }}</span>.
                Estoque atual {{ it.stock }} (m√≠nimo {{ it.estoque_minimo }}).
                {% if it.is_active %}Item ativo.{% else %}Item inativo.{% endif %}
              </p>

              <div class="grid md:grid-cols-4 gap-4 mb-6">
                <div class="card bg-base-100 border"><div class="card-body p-4">
                  <div class="text-xs opacity-70">Estado do item</div>
                  <div>
                    {% if it.is_active %}<span class="badge badge-success">Ativo</span>{% else %}<span class="badge">Inativo</span>{% endif %}
                    {% if it.stock|floatformat:2 < it.estoque_minimo|floatformat:2 %}
                      <span class="badge badge-warning ml-1">Abaixo do m√≠nimo</span>
                    {% endif %}
                  </div>
                </div></div>

                <div class="card bg-base-100 border"><div class="card-body p-4">
                  <div class="text-xs opacity-70">Estoque</div>
                  <div class="font-medium">{{ it.stock }}</div>
                </div></div>

                <div class="card bg-base-100 border"><div class="card-body p-4">
                  <div class="text-xs opacity-70">Estoque m√≠nimo</div>
                  <div class="font-medium">{{ it.estoque_minimo }}</div>
                </div></div>

                <div class="card bg-base-100 border"><div class="card-body p-4">
                  <div class="text-xs opacity-70">Unidade</div>
                  <div class="font-medium">{{ it.unidade|default:"un" }}</div>
                </div></div>
              </div>

              <div class="flex flex-wrap gap-2 mb-6">
                <span class="badge badge-outline">SKU: {{ it.sku }}</span>
                <span class="badge badge-outline">Unid: {{ it.unidade|default:"un" }}</span>
                <span class="badge badge-outline">Est.: {{ it.stock }}</span>
                <span class="badge badge-outline">M√≠n.: {{ it.estoque_minimo }}</span>
              </div>

              <!-- A√á√ïES -->
<!-- A√á√ïES -->
<div class="flex flex-wrap gap-2">
  <a href="{% url 'inventory:item-detail' it.pk %}" class="btn btn-sm">Abrir</a>
  <button class="btn btn-sm btn-primary" @click="edit=true">Editar</button>

  {% if it.is_active %}
    <!-- DESATIVAR -->
    <button type="button" class="btn btn-sm btn-warning btn-outline"
            @click="document.getElementById('deact-{{it.id}}').showModal()">
      Desativar
    </button>
    <dialog id="deact-{{it.id}}" class="modal">
      <div class="modal-box">
        <h3 class="font-bold text-lg">Desativar item</h3>
        <p class="py-2">Tem certeza que deseja desativar <b>{{ it.sku }} ‚Äî {{ it.descricao }}</b>?</p>
        <form method="post" action="{% url 'inventory:item-deactivate' it.pk %}" class="modal-action">
          {% csrf_token %}
          <button type="button" class="btn" onclick="document.getElementById('deact-{{it.id}}').close()">Cancelar</button>
          <button class="btn btn-warning">Desativar</button>
        </form>
      </div>
    </dialog>
  {% else %}
    <!-- ATIVAR -->
    <button type="button" class="btn btn-sm btn-success btn-outline"
            @click="document.getElementById('act-{{it.id}}').showModal()">
      Ativar
    </button>
    <dialog id="act-{{it.id}}" class="modal">
      <div class="modal-box">
        <h3 class="font-bold text-lg">Ativar item</h3>
        <p class="py-2">Reativar <b>{{ it.sku }} ‚Äî {{ it.descricao }}</b> para permitir movimenta√ß√µes?</p>
        <form method="post" action="{% url 'inventory:item-activate' it.pk %}" class="modal-action">
          {% csrf_token %}
          <button type="button" class="btn" onclick="document.getElementById('act-{{it.id}}').close()">Cancelar</button>
          <button class="btn btn-success">Ativar</button>
        </form>
      </div>
    </dialog>
  {% endif %}

  <button class="btn btn-ghost btn-sm ml-auto" @click="$root.openId=null">Fechar</button>
</div>

            </div>

            <!-- EDI√á√ÉO INLINE -->
            <form x-show="edit" x-cloak method="post" action="{% url 'inventory:item-update' it.pk %}"
                  class="card bg-base-100 border mt-2">
              {% csrf_token %}
              <div class="card-body grid md:grid-cols-3 gap-4">
                <label class="form-control">
                  <span class="label-text">SKU</span>
                  <input type="text" name="sku" value="{{ it.sku }}" class="input input-bordered" required>
                </label>
                <label class="form-control md:col-span-2">
                  <span class="label-text">Descri√ß√£o</span>
                  <input type="text" name="descricao" value="{{ it.descricao }}" class="input input-bordered" required>
                </label>
                <label class="form-control">
                  <span class="label-text">Unidade (ex.: un, kg, L)</span>
                  <input type="text" name="unidade" value="{{ it.unidade }}" class="input input-bordered" placeholder="un | kg | L | m | cx">
                </label>
                <label class="form-control">
                  <span class="label-text">Estoque atual</span>
                  <input type="number" step="0.01" name="stock" value="{{ it.stock }}" class="input input-bordered" required>
                </label>
                <label class="form-control">
                  <span class="label-text">Estoque m√≠nimo</span>
                  <input type="number" step="0.01" name="estoque_minimo" value="{{ it.estoque_minimo }}" class="input input-bordered">
                </label>
                <label class="form-control">
                  <span class="label-text">Ativo</span>
                  <input type="checkbox" name="is_active" class="toggle" {% if it.is_active %}checked{% endif %}>
                </label>
                <div class="md:col-span-3 card-actions justify-end">
                  <button type="button" class="btn btn-ghost" @click="edit=false">Cancelar</button>
                  <button class="btn btn-primary">Salvar</button>
                </div>
              </div>
            </form>

          </div>
        </td>
      </tr>
    </tbody>
    {% empty %}
      <tbody><tr><td colspan="7" class="text-center opacity-60">Nada por aqui‚Ä¶</td></tr></tbody>
    {% endfor %}
  </table>
</div>


{% endblock %}
