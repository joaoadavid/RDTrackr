{% extends "global/base.html" %}
{% block page_title %}Itens{% endblock %}
{% block content %}

<!-- Cards de métricas -->
<div class="grid md:grid-cols-4 gap-4 mb-6">
  <div class="card bg-base-100 border"><div class="card-body">
    <span class="text-sm opacity-70">Total de estoque</span>
    <div class="text-3xl font-semibold">{{ stats.total_stock }}</div>
  </div></div>
  <div class="card bg-base-100 border"><div class="card-body">
    <span class="text-sm opacity-70">Itens ativos</span>
    <div class="text-3xl font-semibold">{{ stats.ativos }}</div>
  </div></div>
  <div class="card bg-base-100 border"><div class="card-body">
    <span class="text-sm opacity-70">Abaixo do mínimo</span>
    <div class="text-3xl font-semibold">{{ stats.abaixo_min }}</div>
  </div></div>
  <div class="card bg-base-100 border"><div class="card-body">
    <span class="text-sm opacity-70">Total de itens</span>
    <div class="text-3xl font-semibold">{{ stats.itens }}</div>
  </div></div>
</div>

<!-- Filtros -->
<form method="get" class="flex gap-2 items-end mb-4">
  <label class="form-control w-full max-w-sm">
    <span class="label-text">Buscar</span>
    <input class="input input-bordered" type="text" name="q" value="{{ q }}" placeholder="SKU ou descrição">
  </label>
  <a href="{% url 'inventory:item-create' %}" class="btn btn-primary ml-auto">+ Novo item</a>
</form>

<!-- Tabela -->
<div class="overflow-x-auto">
  <table class="table w-full">
    <thead>
      <tr>
        <th class="w-8"></th>
        <th>SKU</th>
        <th>Descrição</th>
        <th>Unid</th>
        <th>Estoque</th>
        <th>Est. mín.</th>
        <th>Status</th>
        <th class="text-right">Ações</th>
      </tr>
    </thead>

    {% for it in items %}
    <tbody x-data="{ open:false }">
      <!-- linha principal -->
      <tr>
        <td>
          <button class="btn btn-ghost btn-xs" @click="open=!open" :aria-expanded="open">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 transition-transform"
                 :class="open ? 'rotate-180' : ''" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="m6 9 6 6 6-6"/>
            </svg>
          </button>
        </td>
        <td>{{ it.sku }}</td>
        <td class="font-medium">
          <a href="{% url 'inventory:item-detail' it.pk %}" class="link">{{ it.descricao }}</a>
        </td>
        <td>{{ it.unidade }}</td>
        <td>{{ it.stock }}</td>
        <td>{{ it.estoque_minimo }}</td>
        <td>
          {% if it.is_active %}
            <span class="badge badge-success">Ativo</span>
          {% else %}
            <span class="badge badge-ghost">Inativo</span>
          {% endif %}
        </td>
        <td class="text-right">
          <a href="{% url 'inventory:item-detail' it.pk %}" class="btn btn-xs btn-outline">Abrir</a>
        </td>
      </tr>

      <!-- expand -->
      <tr x-show="open" x-cloak>
        <td></td>
        <td colspan="7" class="bg-base-200 p-0">
          <div class="p-4" x-data="{ edit:false }">
            <!-- header ações do expand -->
            <div class="flex items-center gap-2 mb-4">
              <button class="btn btn-sm" @click="edit=true">Editar</button>
              <a href="{% url 'inventory:item-delete' it.pk %}" class="btn btn-sm btn-outline">Excluir</a>
              <button class="btn btn-ghost btn-sm ml-auto" @click="$root.open=false">Fechar</button>
            </div>

            <!-- VISUALIZAÇÃO -->
            <div x-show="!edit" x-cloak>
              <div class="grid md:grid-cols-4 gap-4">
                <div class="card bg-base-100 border"><div class="card-body p-4">
                  <div class="text-sm opacity-70">SKU</div><div class="font-medium">{{ it.sku }}</div>
                </div></div>
                <div class="card bg-base-100 border"><div class="card-body p-4">
                  <div class="text-sm opacity-70">Unidade</div><div class="font-medium">{{ it.unidade }}</div>
                </div></div>
                <div class="card bg-base-100 border"><div class="card-body p-4">
                  <div class="text-sm opacity-70">Estoque</div><div class="font-medium">{{ it.stock }}</div>
                </div></div>
                <div class="card bg-base-100 border"><div class="card-body p-4">
                  <div class="text-sm opacity-70">Est. mínimo</div><div class="font-medium">{{ it.estoque_minimo }}</div>
                </div></div>
              </div>              
            </div>

            <!-- EDIÇÃO INLINE (posta para ItemUpdateView) -->
            <form x-show="edit" x-cloak method="post" action="{% url 'inventory:item-update' it.pk %}"
                  class="card bg-base-100 border">
              {% csrf_token %}
              <div class="card-body grid md:grid-cols-3 gap-4">
                <label class="form-control">
                  <span class="label-text">SKU</span>
                  <input type="text" name="sku" value="{{ it.sku }}" class="input input-bordered" required>
                </label>
                <label class="form-control md:col-span-2">
                  <span class="label-text">Descrição</span>
                  <input type="text" name="descricao" value="{{ it.descricao }}" class="input input-bordered" required>
                </label>
                <label class="form-control">
                  <span class="label-text">Unidade</span>
                  <input type="text" name="unidade" value="{{ it.unidade }}" class="input input-bordered">
                </label>
                <label class="form-control">
                  <span class="label-text">Estoque atual</span>
                  <input type="number" step="0.01" name="stock" value="{{ it.stock }}" class="input input-bordered" required>
                </label>
                <label class="form-control">
                  <span class="label-text">Estoque mínimo</span>
                  <input type="number" step="0.01" name="estoque_minimo" value="{{ it.estoque_minimo }}" class="input input-bordered">
                </label>
                <label class="form-control">
                  <span class="label-text">Ativo</span>
                  <input type="checkbox" name="is_active" class="toggle" {% if it.is_active %}checked{% endif %}>
                </label>

                <div class="md:col-span-3 card-actions justify-end">
                  <button type="button" class="btn btn-ghost" @click="edit=false">Cancelar</button>
                  <button class="btn btn-primary">Salvar</button>
                </div>
              </div>
            </form>

          </div>
        </td>
      </tr>
    </tbody>
    {% empty %}
      <tbody><tr><td colspan="8" class="text-center opacity-60">Nada por aqui…</td></tr></tbody>
    {% endfor %}
  </table>
</div>


  </table>
</div>

{% endblock %}
